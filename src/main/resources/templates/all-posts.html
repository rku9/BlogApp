<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
  <head>
    <meta charset="UTF-8" />
    <title>Posts</title>
    <style>
      .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        margin: 8px 0;
      }

      .filters label {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .posts {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .post-card {
        display: block;
        padding: 16px;
        border: 1px solid #ddd;
        border-radius: 12px;
        text-decoration: none;
        color: inherit;
      }
    </style>
  </head>
  <body>
    <div>
      <h1>My Blog Application</h1>
      <span sec:authorize="isAuthenticated()" style="float: right;">
        Logged in as
        <strong sec:authentication="principal.name">User</strong>
<!--          <strong sec:authentication="principal.password">User</strong>-->
      </span>
      <span sec:authorize="!isAuthenticated()" style="display: inline-flex; gap: 8px;">
        <form th:action="@{/login}" method="get" style="display:inline;">
          <button type="submit">Login</button>
        </form>
        <form th:action="@{/register}" method="get" style="display:inline;">
          <button type="submit">Register</button>
        </form>
      </span>
      <span sec:authorize="isAuthenticated()">
        <form th:action="@{/posts/new}" method="get" sec:authorize="hasAnyAuthority('ROLE_AUTHOR','ROLE_ADMIN')" style="display:inline;">
          <button type="submit">New Post</button>
        </form>
        |
        <form th:action="@{/logout}" method="post" style="display:inline;">
          <button type="submit">Logout</button>
        </form>
      </span>
    </div>

    <form th:action="@{/}" method="get">
      <label for="search">Search</label>
      <input
        id="search"
        type="search"
        name="search"
        th:value="${search}"
        placeholder="Enter keyword"
      />
      <input type="hidden" name="oldSearch" th:value="${oldSearch}" />
      <input type="hidden" name="page" value="0" />
      <input type="hidden" name="size" th:value="${page != null ? page.size : 10}" /><br />

      <div class="filters">
        <strong>Tags</strong>
        <label th:each="t : ${allTags}">
          <input
            type="checkbox"
            name="tagIds"
            th:value="${t.id}"
            th:checked="${selectedTagIds != null && selectedTagIds.contains(t.id)}"
          />
          <span th:text="${t.name}">Tag</span>
        </label>
      </div>

      <div class="filters">
        <strong>Authors</strong>
        <label th:each="a : ${authorOptions}">
          <input
            type="checkbox"
            name="authorNames"
            th:value="${a}"
            th:checked="${selectedAuthors != null && #lists.contains(selectedAuthors, a)}"
          />
          <span th:text="${a}">Author</span>
        </label>
      </div>

      <input type="date" id="fromDate" name="fromDate" th:value="${fromDate}" />
      <input type="date" id="toDate" name="toDate" th:value="${toDate}" />

      <label for="direction">Sort by Published Date</label>
      <select id="direction" name="direction">
        <option value="DESC" th:selected="${direction == 'DESC'}">Newest first</option>
        <option value="ASC" th:selected="${direction == 'ASC'}">Oldest first</option>
      </select>
      <input type="hidden" name="sort" value="publishedAt" />

      <button type="submit">Apply Filters</button>
      <a th:href="@{/}">Clear All</a>
    </form>

    <div class="posts" th:if="${allPosts != null}">
      <a
          class="post-card"
          th:each="post : ${allPosts}"
          th:href="@{/posts/{id}(id=${post.id})}">
        <h3 th:text="${post.title}">Post Title</h3>
        <div>
          <small th:text="${post.author != null ? post.author.name : 'Unknown Author'}">Author</small>
          <span> | </span>
          <small
              th:text="${post.publishedAt != null ? #temporals.format(post.publishedAt.atZone(T(java.time.ZoneId).systemDefault()), 'yyyy-MM-dd HH:mm') : 'Unpublished'}"
          >Published</small>
        </div>
        <p th:text="${post.excerpt}">Post excerpt</p>
        <div th:if="${post.tags != null && !post.tags.isEmpty()}">
          <small>Tags: </small>
          <span th:each="tag,iterStat : ${post.tags}">
            <span th:text="${tag.name}">Tag</span>
            <span th:if="${!iterStat.last}">, </span>
          </span>
        </div>
      </a>
    </div>

    <div th:if="${allPosts == null or allPosts.isEmpty()}">
      <h2>No posts found</h2>
    </div>

    <div th:if="${page != null}">
      <ul>
        <li th:if="${page.hasPrevious()}">
          <a
            th:href="@{/(search=${search},oldSearch=${oldSearch},
                       authorNames=${selectedAuthors},tagIds=${selectedTagIds},
                       fromDate=${fromDate},toDate=${toDate},direction=${direction},
                       page=${page.number-1},size=${page.size})}"
          >Prev</a>
        </li>
        <li>
          Page
          <span th:text="${page.number + 1}"></span>
          of
          <span th:text="${page.totalPages}"></span>
        </li>
        <li th:if="${page.hasNext()}">
          <a
            th:href="@{/(search=${search},oldSearch=${oldSearch},
                       authorNames=${selectedAuthors},tagIds=${selectedTagIds},
                       fromDate=${fromDate},toDate=${toDate},direction=${direction},
                       page=${page.number+1},size=${page.size})}"
          >Next</a>
        </li>
      </ul>
    </div>
  </body>
</html>